#### ADR
Схемы
[https://miro.com/app/board/uXjVImM_ywk=/?share_link_id=689404333085](https://miro.com/app/board/uXjVImM_ywk=/?share_link_id=689404333085)

Обновление связи Streaming: test_task_updated: async -> sync

**status**: _Accepted_

**Сontext**: Изначальное бизнес требование состоит в том чтобы обновлять как можно скорее задание которое решили много раз. В текущей реализации бизнесовое событие о необходимости обновления отправляется синхронно что удовлетворяет бизнес требованиям: менеджер асап получает уведомление о необходимости менять задание.
После этого обновленное задание должно вернуться обратно в сервис найма - тут возникает задержка из-за того что это обновление происходит асинхронно и во время этой задержки кандидаты в учителя успевают начитерить систему и нарешать много легких заданий. 

**Decision**: нужно минимизировать время между обновлением задания менеджером и обновлением этого задания в сервисе найма. Решили перевести связь с асинхронного варианта, на синхронный.

**Consequences**: обновление происходит быстрее, но теперь сервис найма сильнее связан с сервисом заданий. Например если сервис найма упадет то это отразится на сервисе заданий. Для бизнеса это не критично. Работа сервиса найма критична, а сервис заданий может позволить себе полежать. Своевременное обновление заданий и минимизация читерства бизнесу важнее. 

#### Анализ и решения проблем

| Название проблемы | Из-за чего возникла                                                                                                                                                      | Как решилась                                                                                                                                                                                                                                                           |
| ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Problem-010       | После выполнения заданий вызывались долгие синхронные методы зачисления средств в сервисе бонусов.                                                                       | После выполнения заданий складывать событие об этом в очередь. Это не зависит от скорости работы сервис бонусов и выполняется быстрее                                                                                                                                  |
| Problem-020       | Сервис найма получал задания синхронно по инициативе самого сервиса найма. Из-за этого обновленные задания подтягивались не сразу после того как менеджер их исправил    | Теперь обновленные задания отправляются синхронно но по инициативе сервиса задний, сразу после того как менеджер поменяет задание.                                                                                                                                     |
| Problem-030       | Рейтинг задания передавался асинхронно, это вызвало задержки                                                                                                             | Передавать рейтинг задания синхронно                                                                                                                                                                                                                                   |
| Problem-040       | Бонусы начислялись синхронными взовами, которых было очень много, происходил дудос сервиса бонусов.                                                                      | Начислять бонусы через асинхронные события, которые можно обрабатывать батчами выгребая из кафки                                                                                                                                                                       |
| Problem-050       | После выполнения заданий вызывались синхронные методы зачисления средств и если сервис бонусов лежит или перегружен, выскакивали ошибки                                  | После выполнения заданий складывать событие об этом в очередь. Теперь эта часть не зависит от работоспособности сервиса бонусов                                                                                                                                        |
| Problem-060       | Множество синхронных запросов некоторые из которых отдают одни и те же данные по несколько раз (например получение всех заданий или отдача менеджера в 2 других сервиса) | Передавать данные в другие сервисы асинхронно и постепенно по мере их появления и обновления                                                                                                                                                                           |
| Problem-070       | Из-за повторных вызовов методов зачисления бонусов менеджерам                                                                                                            | Ключами идемпотентности в сообщении о зачислении средств                                                                                                                                                                                                               |
| Problem-080       | Множество синхронных связей из-за которых увеличивается связность сервисов                                                                                               | Переделали все связи которые возможно на асинхронные кроме тех без которых невозможно реализовать важную бизнес логику (обновление задач, и рейтинга задачи)                                                                                                           |
| Problem-090       | Текущие абстракции , когда один сервис должен что-то знать о другом. Например сервис найма и заданий знали о бонусах в сервисе бонусов                                   | Перевели сервисы на работу с бизнесовыми событиями в которых содержится информация только о логике самого сервиса генерирующего события. Например вместо зачисления средств, сервис найма создает событие о выполненном задании, а кто его дальше обработает не важно. |
| Problem-100       | Про эту проблему я так и не понял(                                                                                                                                       |                                                                                                                                                                                                                                                                        |
